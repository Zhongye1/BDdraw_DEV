# 元素旋转功能实现文档

## 1. 概述

实现元素旋转功能的实现方案，包括数据结构、交互逻辑、渲染处理和相关组件的实现细节。

## 2. 数据结构设计

### 2.1 CanvasElement 接口扩展

在基础的 CanvasElement 接口中添加了 `rotation` 属性：

```typescript
export interface CanvasElement {
  // ... 其他属性
  rotation?: number // 弧度制 (radians) 元素旋转角度
}
```

### 2.2 StageManagerState 状态扩展

在 StageManager 的状态管理中添加了旋转相关的状态：

```typescript
export interface StageManagerState {
  // ... 其他状态

  // 旋转状态
  rotationInitialStates: Record<
    string,
    {
      x: number
      y: number
      width: number
      height: number
      rotation: number
      cx: number // 元素中心点 x
      cy: number // 元素中心点 y
    }
  > | null
  rotationCenter: { x: number; y: number } | null // 旋转中心（群组中心或单元素中心）
  startRotationAngle: number | null // 鼠标按下时的初始角度
}
```

## 3. 旋转功能实现流程

### 3.1 旋转开始 (onHandleDown)

当用户点击旋转手柄时触发：

1. 设置模式为 'rotating'
2. 计算旋转中心点（选中元素的包围盒中心）
3. 记录鼠标初始角度
4. 保存所有选中元素的初始状态（位置、尺寸、旋转角度等）
5. 锁定撤销/重做管理器

### 3.2 旋转过程 (onPointerMove)

在用户拖拽旋转过程中：

1. 计算当前鼠标角度
2. 计算旋转增量（当前角度 - 起始角度）
3. 对每个选中元素：
   - 计算新的自转角度
   - 计算新的位置（公转）
   - 更新 Store 中的元素属性

### 3.3 旋转结束 (onPointerUp)

当用户释放鼠标时：

1. 解锁撤销/重做管理器
2. 检查是否有实际变化
3. 创建并执行旋转命令（用于撤销/重做）
4. 清理旋转相关状态

## 4. 渲染实现

### 4.1 ElementRenderer 元素渲染

在 ElementRenderer 中，通过设置 pivot 和 rotation 属性实现元素旋转：

```typescript
// 应用旋转
if (data.rotation !== undefined) {
  // 设置旋转中心为元素中心
  g.pivot.set(data.width / 2, data.height / 2)
  g.position.set(data.x + data.width / 2, data.y + data.height / 2)
  g.rotation = data.rotation
}
```

### 4.2 TransformerRenderer 选择框渲染

TransformerRenderer 负责渲染选中元素的边界框和控制手柄：

1. 检测元素是否有旋转属性
2. 如果有旋转，调用 `drawRotatedBounds` 方法绘制旋转后的边界框
3. 如果没有旋转，调用 `drawHandles` 方法绘制普通边界框

#### 4.2.1 drawRotatedBounds 方法

处理旋转元素的选择框绘制：

1. 计算元素包围盒的中心点
2. 计算旋转后的四个角点坐标
3. 绘制旋转后的边界框
4. 在旋转后的位置绘制控制手柄
5. 计算并绘制旋转手柄位置

#### 4.2.2 drawHandles 方法

处理普通元素的选择框绘制：

1. 绘制矩形边界框
2. 在边界框周围绘制控制手柄
3. 绘制旋转手柄

## 5. 数学计算

### 5.1 点绕中心旋转公式

```typescript
private rotatePoint(x: number, y: number, cx: number, cy: number, angle: number) {
  const cos = Math.cos(angle)
  const sin = Math.sin(angle)
  const nx = cos * (x - cx) - sin * (y - cy) + cx
  const ny = sin * (x - cx) + cos * (y - cy) + cy
  return { x: nx, y: ny }
}
```

### 5.2 旋转后角点计算

通过以下公式计算矩形四个角点旋转后的位置：

```
rotatedX = centerX + (cornerX * cos - cornerY * sin)
rotatedY = centerY + (cornerX * sin + cornerY * cos)
```

## 6. 撤销/重做支持

旋转操作通过 UpdateElementCommand 实现撤销/重做功能：

1. 记录操作前的元素状态（初始属性）
2. 记录操作后的元素状态（最终属性）
3. 创建命令对象并加入命令栈
4. 支持通过 undo/redo 方法恢复状态

## 7. 特殊处理

### 7.1 多元素旋转

当前实现中，多元素旋转时：

- 使用第一个有旋转属性的元素的旋转角度作为整体显示角度
- 选择框会跟随这个角度旋转
- 所有元素保持它们相对的旋转角度

### 7.2 旋转手柄位置计算

旋转手柄始终位于选择框顶部中心位置：

1. 计算未旋转时的顶部中心点
2. 将该点按照元素旋转角度进行旋转
3. 从旋转后的顶部中心点向上偏移一定距离放置旋转手柄

## 8. 代码文件结构

```
src/
├── pages/
│   └── canvas/
│       └── Pixi_STM_modules/
│           ├── core/
│           │   └── StageManagerCore.ts     # 主要旋转逻辑实现
│           ├── rendering/
│           │   ├── ElementRenderer.ts      # 元素旋转渲染
│           │   └── TransformerRenderer.ts  # 选择框旋转渲染
│           └── core/
│               └── types.ts                # 相关类型定义
├── stores/
│   └── canvasStore.ts                      # CanvasElement 接口定义
└── lib/
    └── UpdateElementCommand.ts             # 撤销/重做命令实现
```

尾注

1. 旋转使用弧度制而非角度制
2. 旋转中心始终是元素或元素组的中心点
3. 多元素旋转时，选择框显示可能不完全精确，但不影响实际元素旋转
4. 旋转操作会被记录到撤销/重做栈中
